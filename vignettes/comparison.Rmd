---
title: "Comparison of multiple datasets"
description: >
  Learn how to get compare multiple datasets and conditions using TrackMateR.
output:
  rmarkdown::html_vignette:
    fig_width: 8
    fig_height: 8
vignette: >
  %\VignetteIndexEntry{Comparison of multiple datasets}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In the first vignette `vignette("TrackMateR")` we saw how to analyse one TrackMate XML file.
This is one _dataset_, the result of a TrackMate tracking session on a single movie.
A more likely scenario is that you have several datasets, from different conditions.

In this scenario we would like to see:

- a report for each dataset
- a compiled report for all datasets in that condition
- a comparison between conditions of key parameters

## Organising your data

**Recommended**
Start a new RStudio session in a new directory using Create Project.
We find it useful to follow [this convention](https://martinctc.github.io/blog/rstudio-projects-and-working-directories-a-beginner's-guide/) for RStudio projects.
This [gist](https://gist.github.com/quantixed/42625f988a7b5da25b7e333c4a660b97) can be run in the console to quickly set up the folder structure for your new project.
Now place your data in a folder called `Data/` in this directory.

**Required**
Place all your TrackMate XML files into subfolders according to condition.
For example you might have:

* Data/
  + Control/
    - cell1.xml
    - cell2.xml
  + Drug/
    - cell1.xml
    - cell2.xml
    - cell3.xml

Only one level of folders is allowed.

## Analysing multiple datasets

Once the data is in place, a single command will generate a series of reports, summaries and a comparison

```{r, eval = FALSE}
library(TrackMateR)
compareDatasets()
```

The outputs are generated using standard parameters equivalent to `reportDataset()`.
However, it is possible to change the defaults by passing additional parameters.
For example, `compareDatasets(radius = 100)` will use the defaults for everything except the radius for searching for neighbours in the track density analysis.
Parameters that can be changed are:

- N, short - from MSD analysis
- deltaT, mode, nPop, init, timeRes, breaks - from jump distance calculation and fitting
- radius - from track density analysis


## Outputs

In the example above, the code will produce the following in a directory called `Output/`

* Plots/
  + comparison.pdf
  + Control/
    - combined.pdf
    - report_1.pdf
    - report_2.pdf
  + Drug/
    - combined.pdf
    - report_1.pdf
    - report_2.pdf
    - report_3.pdf

That is, the individual reports are saved with a new name (regardless of the original XML filename), all datasets are combined (per condition) in `combined.pdf` and a comparison of a summary of all conditions is saved in the top level folder (`comparison.pdf`).

As well as graphical outputs, `compareDatasets()` saves several csv files of data (to `Outputs/Data/`).
In each condition folder, the data frames are collated and saved.
This includes: TrackMate data, MSD, jump distance and fractal dimension data.
There is also a csv file of the data frame used to plot the average msd for this condition.

Above the condition folders, three csv files are saved.
A collation of the msd summary data `allMSCurves.csv` for all conditions; summary data per dataset `allComparison.csv` which is the data frame used for making the comparison plots; and `allTraceData.csv` which is a data frame of properties per trace per dataset for all conditions.

The idea with these files is that a user can load them back into R and process the data in new ways and go beyond TrackMateR.
An advanced user can make their own data frames by running TrackMateR functions.
A good place to start is to peruse the code for `compareDatasets()` and modify from there.

## Recalibrating TrackMate files

It is possible to recalibrate TrackMate XML files _en masse_ by using a CSV file in the condition subfolder containing the XML files.
A separate CSV file is needed for each condition.
Any conditions that do not need recalibrating simply do not need a CSV file present.
The CSV file can have any name but must follow this format.

```{text}
value,unit
0.04,um
0.07,s

```

Using this file, all XML files in the folder will be recalibrated if they are not already at 0.04 micron pixel size and 0.07 s per frame.
Adjustments smaller than 2.5% are ignored.

In the situation where you have datasets with differing (but correct) timescales and spatial units need to be corrected, use 0 for the value corresponding to time (time rescaling will be ignored) and spatial rescaling will go ahead.
Similarly, if you have different spatial scaling between datasets you can rescale time only by using 0 for the spatial value.
If you have datasets that need calibrating differently, you will need to group them into condition-level subfolders with a single csv file to specify the correct parameters.
Alternatively, consider going back and retracking in TrackMate and specifying the correct parameters.
